name: CI

on:
  pull_request:
    branches: [main]
  workflow_call:
    inputs:
      make-target:
        type: string
        default: validate
  workflow_dispatch:

concurrency:
  group: ci-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install tools
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          if [ "${{ inputs.make-target || 'validate' }}" = "validate-full" ]; then
            go install golang.org/x/vuln/cmd/govulncheck@latest
          fi

      - name: Validate
        run: make -j ${{ inputs.make-target || 'validate' }}

      - name: Coverage summary
        if: always()
        run: |
          go test -coverprofile=coverage.out ./... > /dev/null 2>&1 || true
          if [ ! -f coverage.out ]; then exit 0; fi

          total=$(go tool cover -func=coverage.out | awk '/^total:/ {print $3}')

          {
            echo "## ðŸ“Š Test Coverage: ${total}"
            echo ""
            echo "| Package | Coverage |"
            echo "|---------|----------|"
            go tool cover -func=coverage.out | awk '
              /^total:/ { next }
              {
                split($1, parts, "/")
                pkg = ""
                for (i = 1; i < length(parts); i++) {
                  if (pkg != "") pkg = pkg "/"
                  pkg = pkg parts[i]
                }
                pct = $NF
                gsub(/%/, "", pct)
                v = pct + 0
                count[pkg]++
                sum[pkg] += v
              }
              END {
                for (pkg in sum) {
                  avg = sum[pkg] / count[pkg]
                  if (avg >= 80) icon = "ðŸŸ¢"
                  else if (avg >= 60) icon = "ðŸŸ¡"
                  else icon = "ðŸ”´"
                  printf "| `%s` | %s %.1f%% |\n", pkg, icon, avg
                }
              }
            ' | sort
          } >> "$GITHUB_STEP_SUMMARY"

          rm -f coverage.out
